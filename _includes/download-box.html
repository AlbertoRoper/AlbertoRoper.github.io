{%- assign url = include.file | default: include.url -%}
{%- assign filename = include.filename | default: url | split: '/' | last -%}
<div class="download-box-wrapper">
  <a class="download-box" href="{{ url | relative_url }}" download aria-label="{{ include.label | default: 'Download' }}" data-file="{{ url | relative_url }}" data-filename="{{ filename }}" role="link">
    <div class="db-left">
  {%- if include.icon == 'pdf' -%}
        <!-- PDF icon SVG -->
        <svg class="db-icon db-icon-pdf" width="36" height="36" viewBox="0 0 24 24" aria-hidden="true" focusable="false" role="img">
          <rect x="2" y="3" width="20" height="18" rx="2" ry="2" fill="#d1433b"></rect>
          <path d="M6 8h5v1H6zM6 10h12v1H6zM6 12h12v1H6z" fill="#fff" opacity="0.95"></path>
          <text x="12" y="20" font-size="6" text-anchor="middle" fill="#fff" font-family="Arial, Helvetica, sans-serif">PDF</text>
        </svg>
      {%- elsif include.icon == 'zip' -%}
        <!-- ZIP icon SVG -->
        <svg class="db-icon db-icon-zip" width="36" height="36" viewBox="0 0 24 24" aria-hidden="true" focusable="false" role="img">
          <rect x="2" y="3" width="20" height="18" rx="2" ry="2" fill="#2d6cdf"></rect>
          <path d="M7 7h10v1H7zM7 9h10v1H7zM7 11h10v1H7z" fill="#fff" opacity="0.95"></path>
          <text x="12" y="20" font-size="6" text-anchor="middle" fill="#fff" font-family="Arial, Helvetica, sans-serif">ZIP</text>
        </svg>
      {%- elsif include.icon_svg -%}
        {{ include.icon_svg }}
      {%- elsif include.icon_img -%}
        {%- assign icon_classes = "db-icon db-icon-img" -%}
        {%- if include.icon_class -%}
          {%- assign icon_classes = icon_classes | append: ' ' | append: include.icon_class -%}
        {%- else -%}
          {%- assign icon_classes = icon_classes | append: ' db-icon-circle' -%}
        {%- endif -%}
        <img class="{{ icon_classes }}" src="{{ include.icon_img | relative_url }}" alt="{{ include.icon_alt | default: include.title | default: 'icon' }}" />
      {%- else -%}
        <svg width="28" height="28" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M5 20h14v-2H5v2zm7-18L5.33 9h3.67v6h4V9h3.67L12 2z"/></svg>
      {%- endif -%}
      <div class="db-meta">
        <span class="label">{{ include.title | default: include.label | default: 'Download' }}</span>
        {% if include.desc %}<span class="sub">{{ include.desc }}</span>{% endif %}
      </div>
    </div>
    {%- if include.size and (include.show_size == true or include.show_size == 'true') -%}
      {%- assign size_nb = include.size | replace: ' ', '&nbsp;' -%}
      <span class="db-size">{{ size_nb }}</span>
    {%- endif -%}
  </a>
</div>
<script>
// Attach a one-time handler that forces download via fetch+blob when possible.
(function(){
  if (window.__downloadBoxInitialized) return; window.__downloadBoxInitialized = true;
  document.addEventListener('click', async function(evt){
    const a = evt.target.closest && evt.target.closest('a.download-box');
    if (!a) return;
    // allow normal ctrl/cmd/meta clicks to open in new tab/window
    if (evt.ctrlKey || evt.metaKey || evt.shiftKey || evt.altKey) return;
    const file = a.getAttribute('data-file');
    const filename = a.getAttribute('data-filename') || 'download';
    if (!file) return; // nothing to do
    evt.preventDefault();
    try {
      // fetch same-origin resource as blob and trigger save
      const res = await fetch(file, { credentials: 'same-origin' });
      if (!res.ok) throw new Error('Network response was not ok');
      const blob = await res.blob();
      const blobUrl = URL.createObjectURL(blob);
      const tmp = document.createElement('a');
      tmp.style.display = 'none';
      tmp.href = blobUrl;
      tmp.setAttribute('download', filename);
      document.body.appendChild(tmp);
      tmp.click();
      tmp.remove();
      // revoke after a short delay
      setTimeout(() => URL.revokeObjectURL(blobUrl), 2000);
    } catch (err) {
      // fallback: open in new tab so user can Save As
      console.warn('Download via fetch failed, falling back to open in new tab', err);
      window.open(a.href, '_blank', 'noopener');
    }
  }, false);
})();
</script>