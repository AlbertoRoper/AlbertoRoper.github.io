{%- comment -%}
Include to render publications filtered by a specific tag.

Parameters:
 - tag: the tag to filter by (required)
 - reversed: true|false
 - start: integer (optional) - the start attribute to pass to the <ol>
 - title: optional string - render an <h3> above the list
{%- endcomment -%}

{%- assign tag = include.tag -%}
{%- assign reversed = include.reversed | default: false -%}
{%- assign title = include.title | default: "" -%}

{%- comment -%} collect matching publications into an array {%- endcomment -%}
{%- assign matches = "" | split: "," -%}
{%- for pub in site.data.publications -%}
  {%- if pub.tags -%}
    {%- for t in pub.tags -%}
      {%- if t == tag -%}
        {%- assign matches = matches | push: pub -%}
        {%- break -%}
      {%- endif -%}
    {%- endfor -%}
  {%- endif -%}
{%- endfor -%}

{%- if matches.size > 0 -%}
  {%- assign matches = matches | sort: "year" | reverse -%}
{%- endif -%}

{%- comment -%} determine start attribute: if reversed and no start provided, use matches.size {%- endcomment -%}
{%- assign start_provided = include.start -%}
{%- if (reversed == true or reversed == "true") -%}
  {%- if start_provided == nil or start_provided == "" -%}
    {%- assign start_attr = matches.size -%}
  {%- else -%}
    {%- assign start_attr = start_provided -%}
  {%- endif -%}
{%- else -%}
  {%- assign start_attr = start_provided | default: 0 -%}
{%- endif -%}

{%- if include.title -%}
  <h3>{{ include.title }}</h3>
{%- endif -%}

{%- capture ol_attrs -%}
{%- if reversed == true or reversed == "true" -%} reversed {%- endif -%}
{%- if start_attr and start_attr != 0 -%} start="{{ start_attr }}"{%- endif -%}
{%- endcapture -%}

<div class="container">
  <ol{% if ol_attrs != "" %} {{ ol_attrs }}{% endif %}>
    {% if matches.size == 0 %}
      <li><em>No publications listed under '{{ tag }}'.</em></li>
    {% else %}
      {% for pub in matches %}
        <li>
          {{ pub.authors }}, <em>{{ pub.title }},</em>
          {% if pub.journal and pub.tags contains "published" %}
            <em>{{ pub.journal }},</em>
            {% if pub.volume %}<strong>{{pub.volume}}</strong>,{% endif %}
            {% if pub.page %} {{ pub.page }},{% endif %}
            ({{ pub.year }})
          {% elsif pub.tags contains "submitted" %}
            <em>submitted to {{ pub.journal }}</em> ({{ pub.year }})
          {% elsif pub.tags contains "proceedings" %}
            <em>Contribution to {{ pub.proceedings }}</em> ({{ pub.year }})
          {% else %}
            {% if pub.journal %}
              <em>{{ pub.journal }}</em> ({{ pub.year }})
            {% else %}
              ({{ pub.year }})
            {% endif %}
          {% endif %}
          {% if pub.arxiv %}
            , arXiv: <a href="https://arxiv.org/abs/{{ pub.arxiv }}">{{ pub.arxiv }}</a>.
          {% else %} .
          {% endif %}
          {% if pub.url %}
            <br>Link: <a href="{{ pub.url }}" target="_blank" rel="noopener">{{ pub.url }}</a>
          {% endif %}
        </li>
      {% endfor %}
    {% endif %}
  </ol>
</div>